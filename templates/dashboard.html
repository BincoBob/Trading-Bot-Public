{% extends 'layout.html' %}

{% block title %} - Dashboard{% endblock %}

{% block head %}
<!-- Auto refresh removed - now using JavaScript for dynamic updates -->
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="mb-3">Trading Dashboard</h1>
    </div>
    <div class="col-md-4 text-end">
        <div class="mb-2">
            <button id="toggleBotBtn" class="btn btn-lg btn-danger">
                <i class="fas fa-robot me-2"></i><span id="botStatusText">Enable Trading Bot</span>
            </button>
        </div>
        <div class="card mt-2">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="small fw-bold">API Status:</span>
                    <span id="apiStatusBadge" class="badge bg-secondary">Checking...</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-1">
                    <span class="small fw-bold">Data Source:</span>
                    <span id="apiSourceBadge" class="badge bg-info">Loading...</span>
                </div>
                <div id="apiCooldownInfo" class="small text-muted mt-1" style="display: none;">
                    Cooldown until: <span id="cooldownUntil">-</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <h2 class="mt-4">ðŸ“ˆ Top 5 Volatile Coins unter $5</h2>
        <div id="topVolatileCoins" class="row mt-3"></div>

        <div id="wallet-overview" class="mt-4" style="padding: 20px; background: #f5f5f5; border-radius: 10px; color: #222;">
            <h3>ðŸ’¼ Wallet Ãœbersicht</h3>
            <p><strong>USDT:</strong> <span id="usdt-balance">--</span></p>
            <p><strong>BTC:</strong> <span id="btc-balance">--</span></p>
            <p><strong>Gesamtwert:</strong> <span id="total-value">--</span> USD</p>
            <h4>ðŸª™ Coins im Wallet:</h4>
            <ul id="positions-list"></ul>
        </div>

        <div class="card shadow-sm mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-exchange-alt text-success me-2"></i>Recent Trades
                </h5>
                <a href="/history" class="btn btn-sm btn-outline-secondary">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Type</th>
                                <th>Amount (BTC)</th>
                                <th>Price</th>
                                <th>Value (USD)</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="recentTradesTable">
                            <tr>
                                <td colspan="5" class="text-center py-3">Loading recent trades...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        {{ super() }}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function loadCoinCards() {
        fetch('/api/coins')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('topVolatileCoins');
                container.innerHTML = '';
                data.forEach(coin => {
                    const card = document.createElement('div');
                    card.className = 'col-md-6 col-lg-4 mb-4';
                    card.innerHTML = coin.details;
                    container.appendChild(card);
                });
            })
            .catch(error => {
                console.error('Fehler beim Laden der Coin-Daten:', error);
            });
    }

    function loadWallet() {
        fetch("/api/wallet")
            .then(res => res.json())
            .then(data => {
                document.getElementById("usdt-balance").textContent = data.USDT + " USDT";
                document.getElementById("btc-balance").textContent = data.BTC + " BTC";
                document.getElementById("total-value").textContent = data.total + " USD";

                const list = document.getElementById("positions-list");
                list.innerHTML = "";
                for (const [symbol, value] of Object.entries(data.positions)) {
                    const li = document.createElement("li");
                    li.textContent = `${symbol}: ${value} USD`;
                    list.appendChild(li);
                }
            })
            .catch(err => {
                console.error("Fehler beim Laden des Wallets:", err);
            });
    }

    loadCoinCards();
    setInterval(loadCoinCards, 30000);
    loadWallet();
    setInterval(loadWallet, 30000);
</script>
<script src="{{ url_for('static', filename='js/charts.js') }}?v={{ range(1, 100000) | random }}"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}?v={{ range(1, 100000) | random }}"></script>
{% endblock %}
